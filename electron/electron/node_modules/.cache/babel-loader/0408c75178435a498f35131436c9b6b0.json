{"ast":null,"code":"\"use strict\";\n\nvar libsignal = window.require('libsignal');\n\nvar ByteBuffer = window.require('bytebuffer');\n\nvar KeyHelper = libsignal.KeyHelper;\nexports.KeyHelper = KeyHelper;\nexport function uuidv4() {\n  return ([1e7] + -1e3 + -4e3 + -8e3 + -1e11).replace(/[018]/g, function (c) {\n    return (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16);\n  });\n}\nexport function generateIdentity(store) {\n  return Promise.all([KeyHelper.generateIdentityKeyPair(), KeyHelper.generateRegistrationId()]).then(function (result) {\n    store.put('identityKey', result[0]);\n    store.put('registrationId', result[1]);\n  });\n}\nexport function generatePreKeyBundle(store, preKeyId, signedPreKeyId) {\n  return Promise.all([store.getIdentityKeyPair(), store.getLocalRegistrationId()]).then(function (result) {\n    var identity = result[0];\n    var registrationId = result[1];\n    return Promise.all([KeyHelper.generatePreKey(preKeyId), KeyHelper.generateSignedPreKey(identity, signedPreKeyId)]).then(function (keys) {\n      var preKey = keys[0];\n      var signedPreKey = keys[1];\n      store.storePreKey(preKeyId, preKey.keyPair);\n      store.storeSignedPreKey(signedPreKeyId, signedPreKey.keyPair);\n      return {\n        identityKey: identity.pubKey,\n        registrationId: registrationId,\n        preKey: {\n          keyId: preKeyId,\n          publicKey: preKey.keyPair.pubKey\n        },\n        signedPreKey: {\n          keyId: signedPreKeyId,\n          publicKey: signedPreKey.keyPair.pubKey,\n          signature: signedPreKey.signature\n        }\n      };\n    });\n  });\n}\nexport function getPreKeyBundle(store, preKeyId, signedPreKeyId, signedSignature) {\n  return Promise.all([store.getIdentityKeyPair(), store.getLocalRegistrationId()]).then(function (result) {\n    var identity = result[0];\n    var registrationId = result[1];\n    return Promise.all([store.loadPreKey(preKeyId), store.loadSignedPreKey(signedPreKeyId)]).then(function (keys) {\n      var preKey = keys[0];\n      var signedPreKey = keys[1];\n      return {\n        identityKey: identity.pubKey,\n        registrationId: registrationId,\n        preKey: {\n          keyId: preKeyId,\n          publicKey: preKey.pubKey\n        },\n        signedPreKey: {\n          keyId: signedPreKeyId,\n          publicKey: signedPreKey.pubKey,\n          signature: signedSignature\n        }\n      };\n    });\n  });\n}\nexport function SignalProtocolStore() {\n  this.store = {};\n}\n;\nSignalProtocolStore.prototype = {\n  Direction: {\n    SENDING: 1,\n    RECEIVING: 2\n  },\n  getIdentityKeyPair: function getIdentityKeyPair() {\n    return Promise.resolve(this.get('identityKey'));\n  },\n  getLocalRegistrationId: function getLocalRegistrationId() {\n    return Promise.resolve(this.get('registrationId'));\n  },\n  put: function put(key, value) {\n    if (key === undefined || value === undefined || key === null || value === null) throw new Error(\"Tried to store undefined/null\");\n    this.store[key] = value;\n  },\n  get: function get(key, defaultValue) {\n    if (key === null || key === undefined) throw new Error(\"Tried to get value for undefined/null key\");\n\n    if (key in this.store) {\n      return this.store[key];\n    } else {\n      return defaultValue;\n    }\n  },\n  remove: function remove(key) {\n    if (key === null || key === undefined) throw new Error(\"Tried to remove value for undefined/null key\");\n    delete this.store[key];\n  },\n  isTrustedIdentity: function isTrustedIdentity(identifier, identityKey, direction) {\n    if (identifier === null || identifier === undefined) {\n      throw new Error(\"tried to check identity key for undefined/null key\");\n    }\n\n    if (!(identityKey instanceof ArrayBuffer)) {\n      throw new Error(\"Expected identityKey to be an ArrayBuffer\");\n    }\n\n    var trusted = this.get('identityKey' + identifier);\n\n    if (trusted === undefined) {\n      return Promise.resolve(true);\n    }\n\n    return Promise.resolve(util.toString(identityKey) === util.toString(trusted));\n  },\n  loadIdentityKey: function loadIdentityKey(identifier) {\n    if (identifier === null || identifier === undefined) throw new Error(\"Tried to get identity key for undefined/null key\");\n    return Promise.resolve(this.get('identityKey' + identifier));\n  },\n  saveIdentity: function saveIdentity(identifier, identityKey) {\n    if (identifier === null || identifier === undefined) throw new Error(\"Tried to put identity key for undefined/null key\");\n    var address = new libsignal.SignalProtocolAddress.fromString(identifier);\n    var existing = this.get('identityKey' + address.getName());\n    this.put('identityKey' + address.getName(), identityKey);\n\n    if (existing && util.toString(identityKey) !== util.toString(existing)) {\n      return Promise.resolve(true);\n    } else {\n      return Promise.resolve(false);\n    }\n  },\n\n  /* Returns a prekeypair object or undefined */\n  loadPreKey: function loadPreKey(keyId) {\n    var res = this.get('25519KeypreKey' + keyId);\n\n    if (res !== undefined) {\n      res = {\n        pubKey: res.pubKey,\n        privKey: res.privKey\n      };\n    }\n\n    return Promise.resolve(res);\n  },\n  storePreKey: function storePreKey(keyId, keyPair) {\n    return Promise.resolve(this.put('25519KeypreKey' + keyId, keyPair));\n  },\n  removePreKey: function removePreKey(keyId) {\n    return Promise.resolve(this.remove('25519KeypreKey' + keyId));\n  },\n\n  /* Returns a signed keypair object or undefined */\n  loadSignedPreKey: function loadSignedPreKey(keyId) {\n    var res = this.get('25519KeysignedKey' + keyId);\n\n    if (res !== undefined) {\n      res = {\n        pubKey: res.pubKey,\n        privKey: res.privKey\n      };\n    }\n\n    return Promise.resolve(res);\n  },\n  storeSignedPreKey: function storeSignedPreKey(keyId, keyPair) {\n    return Promise.resolve(this.put('25519KeysignedKey' + keyId, keyPair));\n  },\n  removeSignedPreKey: function removeSignedPreKey(keyId) {\n    return Promise.resolve(this.remove('25519KeysignedKey' + keyId));\n  },\n  loadSession: function loadSession(identifier) {\n    return Promise.resolve(this.get('session' + identifier));\n  },\n  storeSession: function storeSession(identifier, record) {\n    return Promise.resolve(this.put('session' + identifier, record));\n  },\n  removeSession: function removeSession(identifier) {\n    return Promise.resolve(this.remove('session' + identifier));\n  },\n  removeAllSessions: function removeAllSessions(identifier) {\n    for (var id in this.store) {\n      if (id.startsWith('session' + identifier)) {\n        delete this.store[id];\n      }\n    }\n\n    return Promise.resolve();\n  }\n};\n\nvar util = function () {\n  'use strict';\n\n  var StaticArrayBufferProto = new ArrayBuffer().__proto__;\n  return {\n    toString: function toString(thing) {\n      if (typeof thing == 'string') {\n        return thing;\n      }\n\n      return new ByteBuffer.wrap(thing).toString('binary');\n    },\n    toArrayBuffer: function toArrayBuffer(thing) {\n      if (thing === undefined) {\n        return undefined;\n      }\n\n      if (thing === Object(thing)) {\n        if (thing.__proto__ == StaticArrayBufferProto) {\n          return thing;\n        }\n      }\n\n      var str;\n\n      if (typeof thing == \"string\") {\n        str = thing;\n      } else {\n        throw new Error(\"Tried to convert a non-string of type \" + typeof thing + \" to an array buffer\");\n      }\n\n      return new ByteBuffer.wrap(thing, 'binary').toArrayBuffer();\n    },\n    isEqual: function isEqual(a, b) {\n      // TODO: Special-case arraybuffers, etc\n      if (a === undefined || b === undefined) {\n        return false;\n      }\n\n      a = util.toString(a);\n      b = util.toString(b);\n      var maxLength = Math.max(a.length, b.length);\n\n      if (maxLength < 5) {\n        throw new Error(\"a/b compare too short\");\n      }\n\n      return a.substring(0, Math.min(maxLength, a.length)) == b.substring(0, Math.min(maxLength, b.length));\n    }\n  };\n}();\n\nexports.util = util;","map":{"version":3,"sources":["/Users/garybutton/Personal/iron/priv/iron/electron/src/common/custom/util.js"],"names":["libsignal","window","require","ByteBuffer","KeyHelper","exports","uuidv4","replace","c","crypto","getRandomValues","Uint8Array","toString","generateIdentity","store","Promise","all","generateIdentityKeyPair","generateRegistrationId","then","result","put","generatePreKeyBundle","preKeyId","signedPreKeyId","getIdentityKeyPair","getLocalRegistrationId","identity","registrationId","generatePreKey","generateSignedPreKey","keys","preKey","signedPreKey","storePreKey","keyPair","storeSignedPreKey","identityKey","pubKey","keyId","publicKey","signature","getPreKeyBundle","signedSignature","loadPreKey","loadSignedPreKey","SignalProtocolStore","prototype","Direction","SENDING","RECEIVING","resolve","get","key","value","undefined","Error","defaultValue","remove","isTrustedIdentity","identifier","direction","ArrayBuffer","trusted","util","loadIdentityKey","saveIdentity","address","SignalProtocolAddress","fromString","existing","getName","res","privKey","removePreKey","removeSignedPreKey","loadSession","storeSession","record","removeSession","removeAllSessions","id","startsWith","StaticArrayBufferProto","__proto__","thing","wrap","toArrayBuffer","Object","str","isEqual","a","b","maxLength","Math","max","length","substring","min"],"mappings":"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","sourcesContent":["\"use strict\";\n\nconst libsignal = window.require('libsignal');\nconst ByteBuffer = window.require('bytebuffer');\n\nvar KeyHelper = libsignal.KeyHelper;\n\nexports.KeyHelper = KeyHelper;\n\nexport function uuidv4() {\n  return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>\n    (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)\n  )\n}\n\nexport function generateIdentity(store) {\n    return Promise.all([\n        KeyHelper.generateIdentityKeyPair(),\n        KeyHelper.generateRegistrationId(),\n    ]).then(function(result) {\n        store.put('identityKey', result[0]);\n        store.put('registrationId', result[1]);\n    });\n}\n\nexport function generatePreKeyBundle(store, preKeyId, signedPreKeyId) {\n    return Promise.all([\n        store.getIdentityKeyPair(),\n        store.getLocalRegistrationId()\n    ]).then(function(result) {\n        var identity = result[0];\n        var registrationId = result[1];\n\n        return Promise.all([\n            KeyHelper.generatePreKey(preKeyId),\n            KeyHelper.generateSignedPreKey(identity, signedPreKeyId),\n        ]).then(function(keys) {\n            var preKey = keys[0]\n            var signedPreKey = keys[1];\n\n            store.storePreKey(preKeyId, preKey.keyPair);\n            store.storeSignedPreKey(signedPreKeyId, signedPreKey.keyPair);\n\n            return {\n                identityKey: identity.pubKey,\n                registrationId : registrationId,\n                preKey:  {\n                    keyId     : preKeyId,\n                    publicKey : preKey.keyPair.pubKey\n                },\n                signedPreKey: {\n                    keyId     : signedPreKeyId,\n                    publicKey : signedPreKey.keyPair.pubKey,\n                    signature : signedPreKey.signature\n                }\n            };\n        });\n    });\n}\n\nexport function getPreKeyBundle(store, preKeyId, signedPreKeyId, signedSignature) {\n    return Promise.all([\n        store.getIdentityKeyPair(),\n        store.getLocalRegistrationId()\n    ]).then(function(result) {\n        var identity = result[0];\n        var registrationId = result[1];\n\n        return Promise.all([\n            store.loadPreKey(preKeyId),\n            store.loadSignedPreKey(signedPreKeyId),\n        ]).then(function(keys) {\n            var preKey = keys[0]\n            var signedPreKey = keys[1];\n\n            return {\n                identityKey: identity.pubKey,\n                registrationId : registrationId,\n                preKey:  {\n                    keyId     : preKeyId,\n                    publicKey : preKey.pubKey\n                },\n                signedPreKey: {\n                    keyId     : signedPreKeyId,\n                    publicKey : signedPreKey.pubKey,\n                    signature : signedSignature\n                }\n            };\n        });\n    });\n}\n\n\nexport function SignalProtocolStore() {\n  this.store = {};\n};\n\nSignalProtocolStore.prototype = {\n  Direction: {\n    SENDING: 1,\n    RECEIVING: 2,\n  },\n\n  getIdentityKeyPair: function() {\n    return Promise.resolve(this.get('identityKey'));\n  },\n  getLocalRegistrationId: function() {\n    return Promise.resolve(this.get('registrationId'));\n  },\n  put: function(key, value) {\n    if (key === undefined || value === undefined || key === null || value === null)\n      throw new Error(\"Tried to store undefined/null\");\n    this.store[key] = value;\n  },\n  get: function(key, defaultValue) {\n    if (key === null || key === undefined)\n      throw new Error(\"Tried to get value for undefined/null key\");\n    if (key in this.store) {\n      return this.store[key];\n    } else {\n      return defaultValue;\n    }\n  },\n  remove: function(key) {\n    if (key === null || key === undefined)\n      throw new Error(\"Tried to remove value for undefined/null key\");\n    delete this.store[key];\n  },\n\n  isTrustedIdentity: function(identifier, identityKey, direction) {\n    if (identifier === null || identifier === undefined) {\n      throw new Error(\"tried to check identity key for undefined/null key\");\n    }\n    if (!(identityKey instanceof ArrayBuffer)) {\n      throw new Error(\"Expected identityKey to be an ArrayBuffer\");\n    }\n    var trusted = this.get('identityKey' + identifier);\n    if (trusted === undefined) {\n      return Promise.resolve(true);\n    }\n    return Promise.resolve(util.toString(identityKey) === util.toString(trusted));\n  },\n  loadIdentityKey: function(identifier) {\n    if (identifier === null || identifier === undefined)\n      throw new Error(\"Tried to get identity key for undefined/null key\");\n    return Promise.resolve(this.get('identityKey' + identifier));\n  },\n  saveIdentity: function(identifier, identityKey) {\n    if (identifier === null || identifier === undefined)\n      throw new Error(\"Tried to put identity key for undefined/null key\");\n\n    var address = new libsignal.SignalProtocolAddress.fromString(identifier);\n\n    var existing = this.get('identityKey' + address.getName());\n    this.put('identityKey' + address.getName(), identityKey)\n\n    if (existing && util.toString(identityKey) !== util.toString(existing)) {\n      return Promise.resolve(true);\n    } else {\n      return Promise.resolve(false);\n    }\n\n  },\n\n  /* Returns a prekeypair object or undefined */\n  loadPreKey: function(keyId) {\n    var res = this.get('25519KeypreKey' + keyId);\n    if (res !== undefined) {\n      res = { pubKey: res.pubKey, privKey: res.privKey };\n    }\n    return Promise.resolve(res);\n  },\n  storePreKey: function(keyId, keyPair) {\n    return Promise.resolve(this.put('25519KeypreKey' + keyId, keyPair));\n  },\n  removePreKey: function(keyId) {\n    return Promise.resolve(this.remove('25519KeypreKey' + keyId));\n  },\n\n  /* Returns a signed keypair object or undefined */\n  loadSignedPreKey: function(keyId) {\n    var res = this.get('25519KeysignedKey' + keyId);\n    if (res !== undefined) {\n      res = { pubKey: res.pubKey, privKey: res.privKey };\n    }\n    return Promise.resolve(res);\n  },\n  storeSignedPreKey: function(keyId, keyPair) {\n    return Promise.resolve(this.put('25519KeysignedKey' + keyId, keyPair));\n  },\n  removeSignedPreKey: function(keyId) {\n    return Promise.resolve(this.remove('25519KeysignedKey' + keyId));\n  },\n\n  loadSession: function(identifier) {\n    return Promise.resolve(this.get('session' + identifier));\n  },\n  storeSession: function(identifier, record) {\n    return Promise.resolve(this.put('session' + identifier, record));\n  },\n  removeSession: function(identifier) {\n    return Promise.resolve(this.remove('session' + identifier));\n  },\n  removeAllSessions: function(identifier) {\n    for (var id in this.store) {\n      if (id.startsWith('session' + identifier)) {\n        delete this.store[id];\n      }\n    }\n    return Promise.resolve();\n  }\n};\n\nvar util = (function() {\n    'use strict';\n\n    var StaticArrayBufferProto = new ArrayBuffer().__proto__;\n\n    return {\n        toString: function(thing) {\n            if (typeof thing == 'string') {\n                return thing;\n            }\n            return new ByteBuffer.wrap(thing).toString('binary');\n        },\n        toArrayBuffer: function(thing) {\n            if (thing === undefined) {\n                return undefined;\n            }\n            if (thing === Object(thing)) {\n                if (thing.__proto__ == StaticArrayBufferProto) {\n                    return thing;\n                }\n            }\n\n            var str;\n            if (typeof thing == \"string\") {\n                str = thing;\n            } else {\n                throw new Error(\"Tried to convert a non-string of type \" + typeof thing + \" to an array buffer\");\n            }\n            return new ByteBuffer.wrap(thing, 'binary').toArrayBuffer();\n        },\n        isEqual: function(a, b) {\n            // TODO: Special-case arraybuffers, etc\n            if (a === undefined || b === undefined) {\n                return false;\n            }\n            a = util.toString(a);\n            b = util.toString(b);\n            var maxLength = Math.max(a.length, b.length);\n            if (maxLength < 5) {\n                throw new Error(\"a/b compare too short\");\n            }\n            return a.substring(0, Math.min(maxLength, a.length)) == b.substring(0, Math.min(maxLength, b.length));\n        }\n    };\n})();\n\nexports.util = util;\n"]},"metadata":{},"sourceType":"module"}